// Prevent duplicate Zappy injection
if (window.zappyContactFormLoaded) {
    console.log('âš ï¸ Zappy: Contact form handler already loaded, skipping duplicate injection');
} else {
    window.zappyContactFormLoaded = true;
}

// Mobile menu toggle
const mobileToggle = document.querySelector('.mobile-toggle');
const navMenu = document.querySelector('.nav-menu');

if (mobileToggle && navMenu) {
    mobileToggle.addEventListener('click', () => {
        navMenu.classList.toggle('active');
        
        // Animate hamburger
        const spans = mobileToggle.querySelectorAll('span');
        if (navMenu.classList.contains('active')) {
            spans[0].style.transform = 'rotate(45deg) translateY(10px)';

            spans[2].style.transform = 'rotate(-45deg) translateY(-10px)';
        } else {
            spans[0].style.transform = 'none';
            spans[1].style.opacity = '1';
            spans[2].style.transform = 'none';
        }
    });

    // Close menu when clicking on a link
    const navLinks = navMenu.querySelectorAll('a');
    navLinks.forEach(link => {
        link.addEventListener('click', () => {
            navMenu.classList.remove('active');
            const spans = mobileToggle.querySelectorAll('span');
            spans[0].style.transform = 'none';
            spans[1].style.opacity = '1';
            spans[2].style.transform = 'none';
        });
    });

    // Close menu when clicking outside
    document.addEventListener('click', (e) => {
        if (!navMenu.contains(e.target) && !mobileToggle.contains(e.target)) {
            navMenu.classList.remove('active');
            const spans = mobileToggle.querySelectorAll('span');
            spans[0].style.transform = 'none';
            spans[1].style.opacity = '1';
            spans[2].style.transform = 'none';
        }
    });
}

// Smooth scroll for anchor links
document.querySelectorAll('a[href^="#"]').forEach(anchor => {
    anchor.addEventListener('click', function (e) {
        const href = this.getAttribute('href');
        if (href !== '#' && href.length > 1) {
            e.preventDefault();
            const target = document.querySelector(href);
            if (target) {
                target.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        }
    });
});

// Add active class to current nav item
const currentPath = window.location.pathname;
const navLinks = document.querySelectorAll('.nav-menu a');
navLinks.forEach(link => {
    if (link.getAttribute('href') === currentPath) {
        link.classList.add('active');
    }
});

// Contact form handling (basic validation) - ENHANCED WITH ZAPPY API
const contactForm = document.getElementById('contactForm');
if (contactForm) {
    contactForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        // Get form data
        const formData = new FormData(contactForm);
        const data = Object.fromEntries(formData);
        
        // Basic validation
        if (!data.name || !data.phone || !data.email || !data.service || !data.message) {
            alert('× × ×œ××œ× ××ª ×›×œ ×”×©×“×•×ª ×”×—×•×‘×”');
            return;
        }
        
        // Email validation
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(data.email)) {
            alert('× × ×œ×”×–×™×Ÿ ×›×ª×•×‘×ª ××™××™×™×œ ×ª×§×™× ×”');
            return;
        }
        
        // Phone validation (Israeli format)
        const phoneRegex = /^0(5[0-9]|[2-4]|7[0-9]|8|9)[0-9]{7}$/;
        const cleanPhone = data.phone.replace(/[\s-]/g, '');
        if (!phoneRegex.test(cleanPhone)) {
            alert('× × ×œ×”×–×™×Ÿ ××¡×¤×¨ ×˜×œ×¤×•×Ÿ ×ª×§×™×Ÿ');
            return;
        }
        
        // Send to Zappy backend API
        try {
            console.log('ğŸ“§ Zappy: Sending contact form to backend...');
            const response = await fetch('http://localhost:5001/api/email/contact-form', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    websiteId: '105d607e-3dd8-4e57-b51f-98dc3018fbc6',
                    name: data.name,
                    email: data.email,
                    subject: data.service ? `×‘×§×©×ª ×©×™×¨×•×ª: ${data.service}` : '×¤× ×™×™×” ××˜×•×¤×¡ ×™×¦×™×¨×ª ×§×©×¨',
                    message: data.message,
                    phone: cleanPhone
                })
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const result = await response.json();
            console.log('âœ… Zappy: Email sent successfully', result);
        } catch (error) {
            console.error('âŒ Zappy: Failed to send email', error);
            // Don't break existing functionality - continue with success message
        }
        
        // Success message (existing functionality)
        alert('×ª×•×“×”! ×”×”×•×“×¢×” × ×©×œ×—×” ×‘×”×¦×œ×—×”. × ×—×–×•×¨ ××œ×™×š ×‘×”×§×“×.');
        contactForm.reset();
        
        // In production, you would send this data to a server
        console.log('Form data:', data);
    });
}

// Intersection Observer for animations
const observerOptions = {
    threshold: 0.1,
    rootMargin: '0px 0px -50px 0px'
};

const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
        if (entry.isIntersecting) {
            entry.target.style.opacity = '1';
            entry.target.style.transform = 'translateY(0)';
        }
    });
}, observerOptions);

// Observe all cards and sections
const animatedElements = document.querySelectorAll('.service-card, .process-card, .testimonial-card, .value-card, .method-card, .faq-item, .additional-card, .number-card');
animatedElements.forEach(el => {

    el.style.transform = 'translateY(30px)';
    el.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
    observer.observe(el);
});

// Lazy load images
if ('loading' in HTMLImageElement.prototype) {
    const images = document.querySelectorAll('img[loading="lazy"]');
    images.forEach(img => {
        img.src = img.dataset.src;
    });
} else {
    // Fallback for browsers that don't support lazy loading
    const script = document.createElement('script');
    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/lazysizes/5.3.2/lazysizes.min.js';
    document.body.appendChild(script);
}

// Add scroll event for navbar shadow
let lastScroll = 0;
const header = document.querySelector('.header-main');

window.addEventListener('scroll', () => {
    const currentScroll = window.pageYOffset;
    
    if (currentScroll > 100) {
        header.style.boxShadow = '0 4px 16px rgba(0,0,0,0.12)';
    } else {
        header.style.boxShadow = '0 2px 8px rgba(0,0,0,0.08)';
    }
    
    lastScroll = currentScroll;
});

// WhatsApp float button hover effect
const whatsappFloat = document.querySelector('.whatsapp-float');
if (whatsappFloat) {
    whatsappFloat.addEventListener('mouseenter', () => {
        whatsappFloat.style.transform = 'scale(1.1) rotate(5deg)';
    });
    
    whatsappFloat.addEventListener('mouseleave', () => {
        whatsappFloat.style.transform = 'scale(1) rotate(0deg)';
    });
}

/* Cookie Consent */

// Helper function to check cookie consent
function hasConsentFor(category) {
  if (typeof window.CookieConsent === 'undefined') {
    return false; // Default to no consent if cookie consent not loaded
  }
  
  return window.CookieConsent.validConsent(category);
}

// Helper function to execute code only with consent
function withConsent(category, callback) {
  if (hasConsentFor(category)) {
    callback();
  } else {
    console.log(`[WARNING] Skipping ${category} code - no user consent`);
  }
}

// Cookie Consent Initialization

(function() {
  'use strict';
  
  let initAttempts = 0;
  const maxAttempts = 50; // 5 seconds max wait
  
  // Wait for DOM and vanilla-cookieconsent to be ready
  function initCookieConsent() {
    initAttempts++;
    
    
    if (typeof window.CookieConsent === 'undefined') {
      if (initAttempts < maxAttempts) {
        setTimeout(initCookieConsent, 100);
      } else {
      }
      return;
    }

    const cc = window.CookieConsent;
    
    
    // Initialize cookie consent
    try {
      cc.run({
  "autoShow": true,
  "mode": "opt-in",
  "revision": 0,
  "categories": {
    "necessary": {
      "enabled": true,
      "readOnly": true
    },
    "analytics": {
      "enabled": false,
      "readOnly": false,
      "autoClear": {
        "cookies": [
          {
            "name": "_ga"
          },
          {
            "name": "_ga_*"
          },
          {
            "name": "_gid"
          },
          {
            "name": "_gat"
          }
        ]
      }
    },
    "marketing": {
      "enabled": false,
      "readOnly": false,
      "autoClear": {
        "cookies": [
          {
            "name": "_fbp"
          },
          {
            "name": "_fbc"
          },
          {
            "name": "fr"
          }
        ]
      }
    }
  },
  "language": {
    "default": "he",
    "translations": {
      "he": {
        "consentModal": {
          "title": "×× ×—× ×• ××©×ª××©×™× ×‘×¢×•×’×™×•×ª ğŸª",
          "description": "Move It ××©×ª××© ×‘×¢×•×’×™×•×ª ×›×“×™ ×œ×©×¤×¨ ××ª ×”×—×•×•×™×” ×©×œ×š, ×œ× ×ª×— ×©×™××•×© ×‘××ª×¨ ×•×œ×¡×™×™×¢ ×‘××××¦×™ ×”×©×™×•×•×§ ×©×œ× ×•.",
          "acceptAllBtn": "××©×¨ ×”×›×œ",
          "acceptNecessaryBtn": "×¨×§ ×”×›×¨×—×™",
          "showPreferencesBtn": "× ×”×œ ×”×¢×“×¤×•×ª",
          "footer": "<a href=\"#privacy-policy\">××“×™× ×™×•×ª ×¤×¨×˜×™×•×ª</a> | <a href=\"#terms-conditions\">×ª× ××™ ×©×™××•×©</a>"
        },
        "preferencesModal": {
          "title": "×”×¢×“×¤×•×ª ×¢×•×’×™×•×ª",
          "acceptAllBtn": "××©×¨ ×”×›×œ",
          "acceptNecessaryBtn": "×¨×§ ×”×›×¨×—×™",
          "savePreferencesBtn": "×©××•×¨ ×”×¢×“×¤×•×ª",
          "closeIconLabel": "×¡×’×•×¨",
          "sections": [
            {
              "title": "×¢×•×’×™×•×ª ×—×™×•× ×™×•×ª",
              "description": "×¢×•×’×™×•×ª ××œ×” ×”×›×¨×—×™×•×ª ×œ×ª×¤×§×•×“ ×”××ª×¨ ×•×œ× × ×™×ª×Ÿ ×œ×”×©×‘×™×ª ××•×ª×Ÿ.",
              "linkedCategory": "necessary"
            },
            {
              "title": "×¢×•×’×™×•×ª × ×™×ª×•×—",
              "description": "×¢×•×’×™×•×ª ××œ×” ×¢×•×–×¨×•×ª ×œ× ×• ×œ×”×‘×™×Ÿ ××™×š ×”××‘×§×¨×™× ××ª×§×©×¨×™× ×¢× ×”××ª×¨ ×©×œ× ×•.",
              "linkedCategory": "analytics"
            },
            {
              "title": "×¢×•×’×™×•×ª ×©×™×•×•×§×™×•×ª",
              "description": "×¢×•×’×™×•×ª ××œ×” ××©××©×•×ª ×œ×”×¦×’×ª ×¤×¨×¡×•××•×ª ××•×ª×××•×ª ××™×©×™×ª.",
              "linkedCategory": "marketing"
            }
          ]
        }
      }
    }
  },
  "guiOptions": {
    "consentModal": {
      "layout": "box",
      "position": "bottom right",
      "equalWeightButtons": true,
      "flipButtons": false
    },
    "preferencesModal": {
      "layout": "box",
      "equalWeightButtons": true,
      "flipButtons": false
    }
  }
});
      
      // Optional: Handle consent changes (check if onChange is available)
      if (typeof cc.onChange === 'function') {
        cc.onChange(function(cookie, changed_preferences) {
      
      // Enable/disable analytics based on consent
      if (changed_preferences.includes('analytics')) {
        if (cc.validConsent('analytics')) {
          // Enable analytics (e.g., Google Analytics)
          // Example: gtag('consent', 'update', { analytics_storage: 'granted' });
        } else {
          // Example: gtag('consent', 'update', { analytics_storage: 'denied' });
        }
      }
      
      // Enable/disable marketing based on consent
      if (changed_preferences.includes('marketing')) {
        if (cc.validConsent('marketing')) {
          // Example: gtag('consent', 'update', { ad_storage: 'granted' });
        } else {
          // Example: gtag('consent', 'update', { ad_storage: 'denied' });
        }
      }
        });
      } else {
      }

      // Note: Cookie Preferences button removed per marketing guidelines
      // Footer should be clean and minimal - users can manage cookies via banner
    } catch (error) {
    }
  }

  // Initialize when DOM is ready - multiple approaches for reliability
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initCookieConsent);
    // Backup timeout in case DOMContentLoaded doesn't fire
    setTimeout(initCookieConsent, 1000);
  } else if (document.readyState === 'interactive' || document.readyState === 'complete') {
    initCookieConsent();
  } else {
    // Fallback - try after a short delay
    setTimeout(initCookieConsent, 500);
  }
  
  // Additional fallback - try after page load
  if (typeof window !== 'undefined') {
    if (window.addEventListener) {
      window.addEventListener('load', initCookieConsent, { once: true });
    }
  }
})();

/* Accessibility Features */

/* Mickidum Accessibility Toolbar Initialization - Zappy Style */

window.onload = function() {
    
    try {
        window.micAccessTool = new MicAccessTool({
            buttonPosition: 'left', // Position on left side
            forceLang: 'he-